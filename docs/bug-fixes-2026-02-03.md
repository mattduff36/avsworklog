# Bug Fixes - February 3, 2026

## Overview
Fixed six bugs related to plant asset maintenance status, table layout, dialog descriptions, workshop task filtering, and plant navigation/data fetching.

---

## Bug 1: Plant Maintenance Status Counts Hardcoded to Zero

### Issue
Plant asset maintenance status counts (`overdue_count` and `due_soon_count`) were hardcoded to zero, causing the maintenance summary to always report zero overdue and zero due-soon plant assets even if they actually had maintenance issues. This made it impossible for users to see critical maintenance warnings for plant machinery.

### Root Cause
In `PlantOverview.tsx`, the code was creating plant maintenance records with hardcoded zeros:
```typescript
overdue_count: 0, // TODO: Calculate based on maintenance items
due_soon_count: 0, // TODO: Calculate based on maintenance items
```

### Fix
Added proper calculation logic using the existing maintenance utility functions:

1. **Import required utilities**: Added `getDateBasedStatus` and `calculateAlertCounts` from `@/lib/utils/maintenanceCalculations`

2. **Calculate LOLER status**: For each plant asset, calculate the LOLER due date status with a 30-day threshold:
   ```typescript
   const loler_status = getDateBasedStatus(plant.loler_due_date, 30);
   ```

3. **Calculate alert counts**: Use the `calculateAlertCounts` function to determine overdue and due-soon counts:
   ```typescript
   const alertCounts = calculateAlertCounts([loler_status]);
   
   return {
     // ...other fields
     overdue_count: alertCounts.overdue,
     due_soon_count: alertCounts.due_soon,
   };
   ```

### Impact
- Plant assets with overdue or due-soon LOLER inspections now correctly appear in maintenance summaries
- Users can now see critical maintenance warnings for plant machinery
- The maintenance overview accurately reflects plant maintenance status

### Files Changed
- `app/(dashboard)/maintenance/components/PlantOverview.tsx`

---

## Bug 2: Empty State Table Cell Hardcoded colSpan

### Issue
The empty state message in the plant table had a hardcoded `colSpan={6}` that didn't account for column visibility. When users hid columns via the "Show columns" dropdown, the empty state cell would span 6 columns regardless of how many were actually visible, breaking the table layout.

### Root Cause
In `PlantTable.tsx`, the empty state row used a fixed colspan:
```typescript
<TableCell colSpan={6} className="text-center py-8 text-muted-foreground">
```

This didn't account for the `columnVisibility` state which allows users to hide/show columns dynamically.

### Fix
Changed the colspan to dynamically calculate based on visible columns:
```typescript
<TableCell 
  colSpan={Object.values(columnVisibility).filter(Boolean).length} 
  className="text-center py-8 text-muted-foreground"
>
```

This counts how many columns are currently visible and spans exactly that many.

### Impact
- Empty state message now correctly spans all visible columns
- Table layout remains intact when users hide/show columns
- Better responsive behavior

### Files Changed
- `app/(dashboard)/maintenance/components/PlantTable.tsx`

---

## Bug 3: Workshop Task Dialog Description Not Asset-Aware

### Issue
The dialog description for creating workshop tasks said "Add a new vehicle repair or maintenance task" regardless of whether the user was on the vehicle or plant tab. When creating plant tasks, the description should reflect that they're creating a plant task.

### Root Cause
In `workshop-tasks/page.tsx`, the `DialogDescription` had a hardcoded message:
```typescript
<DialogDescription className="text-muted-foreground">
  Add a new vehicle repair or maintenance task
</DialogDescription>
```

### Fix
Made the description dynamic based on the `assetTab` state:
```typescript
<DialogDescription className="text-muted-foreground">
  Add a new {assetTab === 'plant' ? 'plant' : 'vehicle'} repair or maintenance task
</DialogDescription>
```

### Impact
- Users see context-appropriate descriptions when creating workshop tasks
- Clearer UX when working with plant vs. vehicle tasks
- Consistent with the rest of the form which already adapts to asset type

### Files Changed
- `app/(dashboard)/workshop-tasks/page.tsx`

---

## Bug 4: Vehicle Filter Not Reset When Switching Tabs via Settings/Tools

### Issue
When users switched between tabs via the settings or tools tab, the `vehicleFilter` was not reset. If a vehicle ID was previously selected on the vehicle tab and the user navigated back to the plant tab through settings/tools, the filter would attempt to match that vehicle ID against `plant_id` values in the database, which would never match since they're from different ID spaces. This caused the plant tab to display "No plant workshop tasks yet" even though plant tasks existed, masking the real data.

### Root Cause
In `workshop-tasks/page.tsx`, the `handleTabChange` function only reset filters when both the previous and new tabs were 'vehicle' or 'plant':

```typescript
if ((newTab === 'vehicle' || newTab === 'plant') && (previousTab === 'vehicle' || previousTab === 'plant')) {
  setVehicleFilter('all');
  setStatusFilter('all');
}
```

This logic failed when the user navigated through intermediate tabs:
1. User on 'vehicle' tab with vehicle ID "abc123" selected
2. User clicks 'settings' tab → filter NOT reset (previousTab='vehicle', newTab='settings')
3. User clicks 'plant' tab → filter NOT reset (previousTab='settings', newTab='plant')
4. Plant tab now queries for plant_id='abc123' which doesn't exist

### Fix
Simplified the condition to reset filters whenever navigating TO a vehicle or plant tab, regardless of where the user came from:

```typescript
// Reset filters when switching to a different asset type tab (vehicle or plant)
// This ensures filters are cleared when:
// 1. Switching directly between vehicle/plant tabs
// 2. Switching from vehicle/plant to settings/tools and back to the OTHER asset type
// 3. Any tab change that results in a different asset type being displayed
if ((newTab === 'vehicle' || newTab === 'plant') && previousTab !== newTab) {
  setVehicleFilter('all');
  setStatusFilter('all');
}
```

The key change: Removed the requirement that `previousTab` must be 'vehicle' or 'plant'. Now filters reset whenever:
- The new tab is 'vehicle' OR 'plant'
- AND the previous tab is different from the new tab

### Impact
- Filters are properly reset when navigating to vehicle/plant tabs from any other tab
- Plant tasks display correctly even after navigating through settings/tools tabs
- No more confusion from seeing empty results due to mismatched ID filters
- Improved data integrity and user experience

### User Flow Examples

**Before Fix:**
1. User on Vehicle tab, selects vehicle "ABC123" → Shows filtered tasks ✓
2. User clicks Settings tab → Filter still "ABC123" (not visible to user)
3. User clicks Plant tab → Filter still "ABC123", searches for plant_id="ABC123" ✗
4. Result: "No plant workshop tasks yet" (incorrect)

**After Fix:**
1. User on Vehicle tab, selects vehicle "ABC123" → Shows filtered tasks ✓
2. User clicks Settings tab → Filter still "ABC123" (not visible to user)
3. User clicks Plant tab → Filter reset to "all", shows all plant tasks ✓
4. Result: All plant tasks displayed (correct)

### Files Changed
- `app/(dashboard)/workshop-tasks/page.tsx` (lines 204-218)

---

## Bug 5: Plant Navigation Incorrect from PlantOverview

### Issue
When non-managers clicked on plant assets in the PlantOverview component, `handleVehicleClick` always navigated to `/fleet/vehicles/{vehicleId}/history`, but plant assets should navigate to `/fleet/plant/{plantId}/history`. This caused navigation to a non-existent route and broke the plant history viewing feature for non-manager users.

### Root Cause
In `fleet/page.tsx`, the `handleVehicleClick` handler was hardcoded to always navigate to the vehicles history route:

```typescript
const handleVehicleClick = (vehicle: VehicleMaintenanceWithStatus) => {
  const vehicleId = vehicle.vehicle_id || vehicle.id;
  router.push(`/fleet/vehicles/${vehicleId}/history?fromTab=${activeTab}`);
};
```

This handler is used by both `MaintenanceTable` (vehicles) and `PlantOverview` (plant), but didn't differentiate between the two asset types.

### Fix
Added logic to detect whether the asset is a plant or vehicle before constructing the navigation URL:

```typescript
const handleVehicleClick = (vehicle: VehicleMaintenanceWithStatus) => {
  const vehicleId = vehicle.vehicle_id || vehicle.id;
  const assetId = vehicle.plant_id || vehicleId;
  
  // Determine if this is a plant asset or vehicle
  // Plant assets have plant_id set, or vehicle.asset_type === 'plant'
  const isPlant = vehicle.plant_id || vehicle.vehicle?.asset_type === 'plant';
  
  // Navigate to appropriate history page
  if (isPlant) {
    router.push(`/fleet/plant/${assetId}/history?fromTab=${activeTab}`);
  } else {
    router.push(`/fleet/vehicles/${assetId}/history?fromTab=${activeTab}`);
  }
};
```

### Impact
- Non-managers can now successfully view plant asset history
- Clicking on plant assets navigates to the correct plant history page
- Navigation works correctly for both PlantOverview and PlantTable
- Maintains backward compatibility with vehicle navigation

### User Flow

**Before Fix:**
1. Non-manager user clicks plant asset in PlantOverview
2. Navigates to `/fleet/vehicles/plant-uuid/history` ✗
3. 404 error - page doesn't exist
4. User cannot view plant history

**After Fix:**
1. Non-manager user clicks plant asset in PlantOverview
2. Navigates to `/fleet/plant/plant-uuid/history` ✓
3. Plant history page loads correctly
4. User can view maintenance records, LOLER status, and workshop tasks

### Files Changed
- `app/(dashboard)/fleet/page.tsx` (lines 273-288)

---

## Bug 6: Plant Maintenance Data Not Loading on History Page

### Issue
The `fetchMaintenanceRecord` function called `/api/maintenance` expecting to find plant machinery maintenance data in `result.vehicles` array. However, the `/api/maintenance` endpoint only queries the `vehicles` table and never returns `plant` table records. Since plant maintenance data is stored separately in the `vehicle_maintenance` table with `plant_id` foreign keys (not `vehicle_id`), the search for `v.plant_id === plantId` would never find a match. This caused plant maintenance information (current hours, service schedules, LOLER data) to never load on the plant history page.

### Root Cause
In `app/(dashboard)/fleet/plant/[plantId]/history/page.tsx`, the code was calling the wrong API:

```typescript
const fetchMaintenanceRecord = async () => {
  const response = await fetch('/api/maintenance');
  const result = await response.json();
  
  if (result.success) {
    const plantMaintenance = result.vehicles.find(
      (v: any) => v.plant_id === plantId
    );
    // This would never find a match because:
    // 1. /api/maintenance only queries the 'vehicles' table
    // 2. Plant records are in the separate 'plant' table
    // 3. plant_id is a foreign key in vehicle_maintenance, not in vehicles
  }
};
```

The `/api/maintenance` endpoint (line 78-94 in `app/api/maintenance/route.ts`):
```typescript
const { data: vehicles } = await supabase
  .from('vehicles')  // Only queries vehicles table
  .select(`
    id,
    reg_number,
    plant_id,      // This is NULL for vehicles, only set for old migrated plant records
    asset_type,
    ...
  `)
  .eq('status', 'active');
```

After the plant table split migration, plant data lives in the `plant` table, and the `vehicle_maintenance` table uses `plant_id` as a foreign key to link maintenance records to plant assets.

### Fix
Changed to directly query the `vehicle_maintenance` and `plant` tables:

```typescript
const fetchMaintenanceRecord = async () => {
  try {
    // Fetch plant maintenance record directly from vehicle_maintenance table
    const { data: maintenanceData, error: maintenanceError } = await supabase
      .from('vehicle_maintenance')
      .select('*')
      .eq('plant_id', unwrappedParams.plantId)
      .maybeSingle();

    if (maintenanceError) {
      console.error('Maintenance query error:', maintenanceError);
      return;
    }

    if (maintenanceData) {
      // Fetch the plant data to combine with maintenance record
      const { data: plantData } = await supabase
        .from('plant')
        .select('loler_due_date, current_hours')
        .eq('id', unwrappedParams.plantId)
        .single();

      // Combine plant data with maintenance data
      setMaintenanceRecord({
        ...maintenanceData,
        loler_due_date: plantData?.loler_due_date,
        current_hours: maintenanceData.current_hours || plantData?.current_hours,
      });
    }
  } catch (error) {
    console.error('Error fetching maintenance record:', error);
  }
};
```

### Impact
- Plant maintenance data now loads correctly on plant history pages
- Current hours, service schedules, and LOLER information display properly
- Users can see complete maintenance history for plant assets
- Eliminates console errors about missing maintenance data

### Database Structure Context
After the plant table split migration:
- **plant** table: Stores plant asset master data (plant_id, LOLER dates, hours, etc.)
- **vehicle_maintenance** table: Stores maintenance schedules with either `vehicle_id` OR `plant_id`
- **vehicles** table: Only stores actual vehicles (trucks, vans, etc.)

Plant maintenance queries must:
1. Query `vehicle_maintenance` with `plant_id` filter
2. Query `plant` table for LOLER and hours data
3. Combine both sources for complete maintenance picture

### Files Changed
- `app/(dashboard)/fleet/plant/[plantId]/history/page.tsx` (lines 115-147)

---

## Testing Recommendations

### Bug 1 - Plant Maintenance Status
1. Navigate to the Maintenance page and view the Plant tab
2. Add a plant asset with a LOLER due date in the past (overdue)
3. Verify the maintenance summary shows "1 overdue"
4. Add a plant asset with a LOLER due date within 30 days
5. Verify the summary shows "1 due soon"

### Bug 2 - Dynamic colSpan
1. Navigate to Maintenance > Plant tab
2. Use the "Show columns" dropdown to hide several columns
3. Clear the search to trigger the empty state
4. Verify the empty state message spans the full width of the table
5. Show/hide different combinations of columns and verify layout remains correct

### Bug 3 - Workshop Task Dialog
1. Navigate to Workshop Tasks page
2. Click "Create Task" on the Vehicle tab
3. Verify dialog says "Add a new vehicle repair or maintenance task"
4. Switch to Plant tab
5. Click "Create Task"
6. Verify dialog says "Add a new plant repair or maintenance task"

### Bug 4 - Filter Reset on Tab Navigation
1. Navigate to Workshop Tasks page (Vehicle tab by default)
2. Select a specific vehicle from the filter dropdown
3. Verify only tasks for that vehicle are displayed
4. Click the "Settings" tab
5. Click the "Plant" tab
6. Verify ALL plant tasks are displayed (filter was reset)
7. Repeat test: Vehicle tab → Tools tab → Vehicle tab (should show all vehicle tasks)
8. Repeat test: Plant tab → Settings tab → Vehicle tab (should show all vehicle tasks)

### Bug 5 - Plant Navigation from Overview
1. Log in as a non-manager user (driver or office staff)
2. Navigate to Fleet > Plant tab
3. View the PlantOverview component (non-managers see overview, not table)
4. Click on any plant asset card
5. Verify navigation goes to `/fleet/plant/{plantId}/history` (not `/fleet/vehicles/`)
6. Verify the plant history page loads correctly
7. Test with manager account clicking from PlantTable as well

### Bug 6 - Plant Maintenance Data Loading
1. Navigate to `/fleet/plant/{plantId}/history` for any plant asset
2. Wait for page to load
3. Verify "Current Hours" displays the actual hours value (not empty/null)
4. Verify "Service Due" displays the service schedule (if set)
5. Verify LOLER information displays correctly
6. Check browser console - should not see errors about maintenance data not found
7. Verify data persists after page refresh

---

## Technical Details

### Maintenance Calculations
The fix for Bug 1 uses the existing maintenance calculation infrastructure:
- `getDateBasedStatus(dueDate, thresholdDays)`: Calculates if a date-based item is overdue, due soon, ok, or not set
- `calculateAlertCounts(statuses[])`: Aggregates status counts across multiple maintenance items

For plant assets, we currently track:
- **LOLER due date**: Primary safety inspection requirement (30-day threshold)
- **Service hours**: Hours-based maintenance (not yet included in status calculations)

Future enhancement: Add hours-based service status to the alert counts calculation.

### Column Visibility Pattern
The dynamic colspan pattern used in Bug 2 can be applied to other tables:
```typescript
colSpan={Object.values(columnVisibility).filter(Boolean).length}
```

This counts the number of `true` values in the `columnVisibility` state object.

### Asset-Aware UI Pattern
The pattern used in Bug 3 (conditional rendering based on `assetTab`) is already used throughout the component. This fix brings consistency to the dialog description.

### Filter Reset Logic
The fix for Bug 4 uses a simpler, more robust condition:
- **Before**: Only reset if both tabs are asset-type tabs
- **After**: Reset whenever navigating TO an asset-type tab (vehicle/plant)

This ensures filters are cleared in all navigation scenarios, preventing ID space mismatches.

### Navigation Pattern for Mixed Asset Types
The fix for Bug 5 implements proper asset-type detection before navigation:
```typescript
const isPlant = vehicle.plant_id || vehicle.vehicle?.asset_type === 'plant';
if (isPlant) {
  router.push(`/fleet/plant/${assetId}/history?fromTab=${activeTab}`);
} else {
  router.push(`/fleet/vehicles/${assetId}/history?fromTab=${activeTab}`);
}
```

This pattern can be reused anywhere we need to navigate to asset history pages.

### Direct Database Queries for Plant Data
The fix for Bug 6 demonstrates the proper way to fetch plant maintenance data:
1. Query `vehicle_maintenance` table with `plant_id` filter
2. Query `plant` table for LOLER and hours data
3. Combine both data sources into a unified maintenance record

This avoids the `/api/maintenance` endpoint which only handles vehicle data.

