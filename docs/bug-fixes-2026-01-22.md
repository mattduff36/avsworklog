# Bug Fixes - January 22, 2026

## Issue 1: RAMS Upload Returns HTML Instead of JSON ✅ FIXED

### Original Error
```
Console Error: Upload error: Error: Failed to upload file: 
Unexpected token '<', "<html><h"... is not valid JSON

User: George Healey
Page: https://www.squiresapp.com/rams/manage
```

### Root Cause
The middleware was redirecting **all** unauthenticated requests (including API routes) to the `/login` page, which returns HTML. When the client tried to parse this HTML as JSON, it failed with "Unexpected token '<'".

### Fixes Applied

#### 1. Middleware Fix (`lib/supabase/middleware.ts`)
Added special handling for API routes to return JSON 401 instead of HTML redirect:

```typescript
const isApiRoute = request.nextUrl.pathname.startsWith('/api/')

if (!isPublicPath && !user) {
  // For API routes, return JSON 401 instead of HTML redirect
  if (isApiRoute) {
    return NextResponse.json(
      { error: 'Unauthorized' },
      { status: 401 }
    )
  }
  
  // For page routes, redirect to login (existing behavior)
  ...
}
```

#### 2. Client-Side Error Handling (`components/rams/UploadRAMSModal.tsx`)
Added content-type validation before parsing JSON:

```typescript
// Check if response is JSON before parsing
const contentType = response.headers.get('content-type');
if (!contentType || !contentType.includes('application/json')) {
  throw new Error('Server returned invalid response. Please try logging in again.');
}

const data = await response.json();
```

### Expected Result
- API routes now return proper JSON error responses
- Users get clear error message if session expires
- No more "Unexpected token '<'" errors

---

## Issue 2: Workshop Attachment Question Cannot Be Deleted ✅ FIXED

### Original Error
```
Console Error: Error deleting question: Error: 
update or delete on table "workshop_attachment_questions" violates 
foreign key constraint "workshop_attachment_responses_question_id_fkey" 
on table "workshop_attachment_responses"

User: Andy Hill
Page: https://www.squiresapp.com/workshop-tasks
```

### Root Cause
The foreign key constraint on `workshop_attachment_responses.question_id` did not have `ON DELETE CASCADE`. When trying to delete a question that had responses, PostgreSQL blocked the deletion to maintain referential integrity.

### Fix Applied

#### Database Migration (`supabase/migrations/20260122_fix_workshop_attachment_cascade.sql`)
Updated the foreign key constraint to cascade deletes:

```sql
-- Drop the existing constraint
ALTER TABLE workshop_attachment_responses
  DROP CONSTRAINT IF EXISTS workshop_attachment_responses_question_id_fkey;

-- Recreate with ON DELETE CASCADE
ALTER TABLE workshop_attachment_responses
  ADD CONSTRAINT workshop_attachment_responses_question_id_fkey
  FOREIGN KEY (question_id)
  REFERENCES workshop_attachment_questions(id)
  ON DELETE CASCADE;
```

### Expected Result
- Users can now delete attachment template questions
- Associated responses are automatically deleted
- No more foreign key constraint violations

### Migration Applied
✅ **Confirmed** - Constraint now includes `ON DELETE CASCADE`

---

## Testing Recommendations

1. **RAMS Upload:**
   - Test uploading a RAMS document with an expired/invalid session
   - Should receive clear error message instead of HTML parse error
   - After re-login, upload should work

2. **Workshop Question Deletion:**
   - Create a test question in an attachment template
   - Add some responses to it
   - Delete the question
   - Should delete successfully without error
   - Responses should be automatically cleaned up

---

## Files Modified

### Frontend
- `lib/supabase/middleware.ts` - Added API route JSON response handling
- `components/rams/UploadRAMSModal.tsx` - Added content-type validation

### Database
- `supabase/migrations/20260122_fix_workshop_attachment_cascade.sql` - Added CASCADE DELETE

### Scripts
- `scripts/run-fix-workshop-cascade.ts` - Migration runner for workshop fix
