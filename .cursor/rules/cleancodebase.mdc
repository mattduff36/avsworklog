---
description: Triggered when the user types "cleancodebase" or "clean codebase" in chat. Runs a tiered codebase audit (Quick / Medium / Full) and proposes fixes.
globs:
alwaysApply: false
---

# cleancodebase — Tiered Codebase Audit & Cleanup

When the user types **"cleancodebase"** or **"clean codebase"**, execute the following steps in order.

---

## Step 1: Ask which audit tier to run

Present this prompt and **wait** for the user to reply **1**, **2**, or **3**:

> **Pick an audit level:**
>
> 1. **Quick** — ESLint + oxlint + depcheck *(fast, no build or server needed)*
> 2. **Medium** — Quick checks + production build *(catches type errors, unused exports, bundle issues)*
> 3. **Full** — Everything: lint, oxlint, depcheck, production build, link check, Lighthouse *(needs dev server on :3000)*

Do **not** proceed until the user has chosen a tier.

---

## Step 2: Execute the selected checks

Run the commands for the chosen tier **from the project root** in a terminal:

### Tier 1 — Quick

```bash
npm run lint
npm run lint:fast
npm run deps:check
```

### Tier 2 — Medium

```bash
npm run lint
npm run lint:fast
npm run deps:check
npm run build
```

### Tier 3 — Full

1. Start the dev server in a background terminal if not already running:

```bash
npm run dev
```

2. Run the full audit suite:

```bash
npm run audit:all
```

This runs: ESLint → oxlint → depcheck → bundle-analyzed build → linkinator → Lighthouse CI.

Capture the **complete console output** from every stage.

---

## Step 3: Parse outputs and report findings

Group every real issue into three severity levels:

### High
- Security vulnerabilities
- Crashes or potential crashes
- Broken links on important routes
- Severe performance regressions (Lighthouse score drops)

### Medium
- Significant code smells (high cognitive complexity)
- Large or growing bundle sizes
- Duplicated logic flagged by sonarjs
- Unused dependencies that add confusion or attack surface

### Low
- Style warnings
- Minor lint issues
- Small optimisation opportunities

For **each issue** provide:
- **Tool**: which check found it
- **Location**: file path and line range (if available)
- **Description**: one-line summary
- **Suggested fix**: concrete action

Present the full report and **wait for user approval** before editing any files.

---

## Step 4: Apply fixes (after approval)

1. Apply edits in **small batches grouped by file**.
2. After each batch, re-run the **relevant check** on touched files:
   - `npx eslint <file>` and `npx oxlint <file>` for lint fixes
   - `npm run deps:check` if dependencies changed
   - `npm run build` if build-related changes were made
3. Report pass/fail after each batch.

---

## Step 5: Summarise and commit

1. Provide a final summary:
   - Changes applied
   - Remaining issues (if any) and recommended next steps
2. Commit locally following project git conventions (`type(scope): summary` on a feature branch).
3. Say: **"✅ Complete. Changes committed locally. Say 'push to GitHub' to push."** and wait.

---

## Important notes

- The audit scripts are defined in `package.json` under `scripts` (`lint`, `lint:fast`, `deps:check`, `build:analyze`, `test:links`, `test:lighthouse`, `audit:all`).
- ESLint config lives in `eslint.config.mjs` (flat config, ESLint 9+). There is no legacy `.eslintrc.*`.
- TypeScript strict flags (`noUnusedLocals`, `noUnusedParameters`, `noFallthroughCasesInSwitch`) are already enabled in `tsconfig.json`.
- Do **not** push to GitHub unless the user explicitly says "push to GitHub".
- For Tier 3, the dev server must be running on `http://localhost:3000` for link checking and Lighthouse.
